---
title: 'Análisis de datos: Netfliz Prize Program'
author: "Laura Basalo Tur, Camila Pérez"
date: "20/11/2020"
output:
  html_document:
    toc: yes
    number_sections: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::kable
library(tidyverse)
library(lubridate) #Trabajar con fechas
library(ggimage) #Gggplot images
library(magick)
library(knitr) # dynamic report generation
library(gridExtra) # miscellaneous Functions for "Grid" Graphics
library(grid) # add Grid to a Plot
rm(list=ls())
cat("\014") ## limpia la pantalla del R
```

<center><img
src="imgs/netflix-intro2.gif">
</center>


# **Introducción**

En el presente estudio se procederá a analizar el data set llamado "Netflix Prize data" obtenido en la web Kaggle. 
Esta base de datos cuenta con un tamaño de espacio en memoria demasiado elevado, por lo que se procedera a extraer una parte de los datos.

TODO: Comentar...


# **Carga de datos**

TODO: Comentar...


```{r message = FALSE}
#Se importan 'n' observaciones del conjunto de datos 'Netflix Prize data'
n = 10000
dataframe = read_tsv("data/combined_data_1.txt", col_names=FALSE, n_max = n)

#Se importa el dataframe de los datos de las películas
n_mov = 10
df_movies = read_csv("data/movie_titles.csv", col_names = FALSE, n_max = n_mov)
```



# **Conociendo el dataframe y sus variables**

TODO: Comentar...

## Estructura
```{r message=FALSE, warning=FALSE}
#Structure 
str(dataframe)
```

## Resumen 
```{r message=FALSE, warning=FALSE}
#Summary
knitr::kable(summary(dataframe))
```


## Primeras 10 filas
```{r message=FALSE, warning=FALSE}
# First 10 rows 
knitr::kable(head(dataframe))
```


## Estructura
```{r message=FALSE, warning=FALSE}
#Structure 
str(df_movies)
```



# **Limpieza de datos**

TODO: Comentar...

```{r message = FALSE}
#Se asigna una posición a cada observación para posteriormente indicar el id de película de cada una de ellas
dataframe = dataframe %>% 
            mutate(Idx = row_number()) 
rows = grep(":", dataframe$X1) 
rows_ID = dataframe %>% 
          filter( Idx %in% rows ) 
IDs = unique(rows_ID$X1)
reps = diff(c(rows_ID$Idx,max(dataframe$Idx)+1))

df = dataframe %>% 
     mutate(MovieID = rep(rows_ID$X1,times= reps)) %>% 
     filter(!(Idx %in% rows_ID))

#Se definen las columnas del dataframe
df = df %>% 
     separate(X1,into = c("CustomerID","Rating","RatingDate"), sep = ",") %>%
     na.omit(df) %>%
     mutate(Idx = row_number())

#Se eliminan las variables auxiliares
rm(dataframe,rows,rows_ID,IDs,reps)
```

```{r}
df_movies = df_movies %>% 
     rename(
      MovieID = X1,
      MovieRelease = X2,
      Title = X3
     )

```




```{r}
#Se elimina el caracter ':' de la columna del MovieID
df$MovieID = unlist(strsplit(df$MovieID , split = ':', fixed=FALSE))

#Se transforman la variable 'Rating' a númerica
df$Rating = as.numeric(df$Rating)

df$RatingDate = as.Date(df$RatingDate, format = "%Y-%m-%d")

#Se unifica el dataframe de las puntuaciones con el de las películas
df = merge(x = df, y = df_movies, by = "MovieID", all = TRUE)

#Se añade la diferencia en años entre el año de puntuación y el de estreno de la película
df = mutate(df, YearsSinceRelease = year(RatingDate) - MovieRelease)


#Se ordenan las posiciones de las columnas y se indican su nuevo nombre
df = select(df, Idx, MovieID, Title, CustomerID, Rating, RatingDate, MovieRelease, YearsSinceRelease)

```




# **Analizando el dataframe**


## Calificaciones de las películas

### Calificación general 

Analizar número de votaciones de las diferentes películas. ¿Cuántas películas hay de cada rating (1,2,3,4 y 5 estrellas)?

```{r}
ggplot(data = df, aes(x = Rating)) +
  geom_bar(aes(y = ..prop.., fill = ..count..), 
           stat="count", 
           show.legend = FALSE) +
  geom_label(aes(label = ..count.., y = ..prop..), 
            stat = "count",
            vjust = -.5) +
  scale_fill_gradient(low = "lightcoral", high = "firebrick2")+
  labs(x = "Rating", y = "Number of ratings", title = "Total Ratings")+
  coord_flip() + 
  theme_classic()

# Image in the visualization 
image = image_read("imgs/icon-rating.png") 
grid.raster(image, x = 0.80, y = 0.25, height = 0.23)

```


### Analizar nº de votaciones/puntuación de cada película

### Película con mejor y peor calificación (gráfico palabras)

### Película más votada y menos votada (gráfico palabras)



## Relación fecha puntuación / calificación

### ¿Cuántas puntuaciones hay por cada año?

### Media del rating por año



## Relación fecha release de la película / calificación

### Relación fecha película con la fecha puntuación y la puntuación 

### ¿Si las fechas de release y puntuación son cercanas, la puntuación es mejor o peor? Revisar la diferencia de las fechas


## Tiempos

### Tiempo medio que ha pasado desde el estreno de la película hasta que ha sido puntuada

### Cantidad de tiempo entre estreno y calificación (Nº de casos)
