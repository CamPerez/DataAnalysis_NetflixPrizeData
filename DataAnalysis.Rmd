---
title: 'Análisis de datos: Netfliz Prize Program'
author: "Laura Basalo Tur, Camila Pérez"
date: "20/11/2020"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::kable
library(tidyverse)
library(lubridate) #Trabajar con fechas
library(ggimage) #Gggplot images
library(magick)
library(knitr) # dynamic report generation
library(gridExtra) # miscellaneous Functions for "Grid" Graphics
library(grid) # add Grid to a Plot
rm(list=ls())
cat("\014") ## limpia la pantalla del R
```

<center><img
src="imgs/netflix-intro2.gif">
</center>


# **Introducción**

En el presente estudio se procederá a analizar el data set llamado *"Netflix Prize data"* obtenido en la página web Kaggle. Dicho dataset se creó como una competición para encontrar el mejor algoritmo de predicción de la puntuación que los usuarios dan a las películas de la plataforma. 

Antes de extraer la información y comenzar a trabajar sobre ella se ha procedido a visualizar a qué tipo de datos íbamos a enfrentarnos. El dataset contiene diversos archivos pero solo nos centraremos con los que vamos a trabajar en este estudio: 


#### Combined Data

Los archivos *'combined_data_{nº}'* contienen la información de las puntuaciones de los usuarios para determinado código de película, así como el identificador de usuario y la fecha (día, mes y año) en la que se dio dicha valoración. 

Esta base de datos cuenta con un tamaño de espacio en memoria demasiado elevado, por lo que se procederá a extraer una parte de los datos y nos quedaremos con las 100 primeras películas de cada archivo.


#### Movie titles

Otro de los archivos que se utilizarán en este estudio contiene el título de cada ID asociado a las películas además del año en el que se estrenó. En secciones posteriores explicaremos como realizaremos la inclusión de estos datos junto con los datos iniciales para obtener el dataset final para trabajar más comodamente.


Una vez realizado este proceso, pensamos en generar nuevas variables para incluirlas en nuestro estudio ya que sería interesante medir la diferencia de años transcurridos desde el estreno hasta la puntuación de las diferentes películas ("YearsSinceRelease").


# **Carga de datos**

TODO: Comentar...


```{r message = FALSE}
#Se importan 'n' observaciones del conjunto de datos 'Netflix Prize data'
#n = 10000
n = 352872-1 # leo las primeras 100 películas 
dataframe = read_tsv("data/combined_data_1.txt", col_names=FALSE, n_max = n)

#Se importa el dataframe de los datos de las películas
n_mov = 100
df_movies = read_csv("data/movie_titles.csv", col_names = FALSE, n_max = n_mov)
```



# **Conociendo el dataframe y sus variables**

TODO: Comentar...

## Estructura
```{r message=FALSE, warning=FALSE}
#Structure 
str_df = str(dataframe)
```

## Resumen 
```{r message=FALSE, warning=FALSE}
#Summary
sum = kable(summary(dataframe))
```


## Primeras 10 filas
```{r message=FALSE, warning=FALSE}
# First 10 rows 
head = kable(head(dataframe))
```


## Estructura
```{r message=FALSE, warning=FALSE}
#Structure 
str_mov = str(df_movies)
```



# **Limpieza de datos**

TODO: Comentar...

```{r message = FALSE}
#Se asigna una posición a cada observación para posteriormente indicar el id de película de cada una de ellas
dataframe = dataframe %>% 
            mutate(Idx = row_number()) 

#Guardamos la fila donde empieza cada película
movie_rows = grep(":", dataframe$X1) 

#Añadimos el id de la película a cada posición y eliminamos el caracter ":"
rows_ID = dataframe %>% 
          filter(Idx %in% movie_rows) %>%
          mutate(X1 = as.integer(gsub(":","",X1)))

#Número de veces que se tendrá que repetir el identificador de cada película
reps = diff(c(rows_ID$Idx, max(dataframe$Idx) + 1))
df = dataframe %>% 
     mutate(MovieID = rep(rows_ID$X1, times = reps)) %>% 
     filter(!(Idx %in% rows_ID))

#Se definen las columnas del dataframe
df = df %>% 
     separate(X1,into = c("UserID","Rating","RatingDate"), sep = ",") %>%
     na.omit(df) %>%
     mutate(Idx = row_number())

#Se eliminan las variables auxiliares
rm(dataframe, movie_rows, rows_ID, reps)
```

```{r}
df_movies = df_movies %>% 
     rename(
      MovieID = X1,
      MovieRelease = X2,
      Title = X3
     )

```




```{r}
#Se transforma la variable 'Rating' a tipo númerica
df$Rating = as.numeric(df$Rating)

#Se transforma la variable 'RatingDate' a tipo date
df$RatingDate = as.Date(df$RatingDate, format = "%Y-%m-%d")

#Se unifica el dataframe de las puntuaciones con el de las películas
df = merge(x = df, y = df_movies, by = "MovieID", all = TRUE)

#Se añade la diferencia en años entre el año de puntuación y el de estreno de la película
df = mutate(df, YearsSinceRelease = year(RatingDate) - MovieRelease)

#Se ordenan las posiciones de las columnas y se indican su nuevo nombre
df = select(df, Idx, MovieID, Title, UserID, Rating, RatingDate, MovieRelease, YearsSinceRelease)

```




# **Analizando el dataframe**


```{r}
glimpse(df)
ncol(df)
nrow(df)
length(unique(df$UserID))
```





## Calificaciones de las películas

### Calificación general 

Analizar número de votaciones de las diferentes películas. ¿Cuántas películas hay de cada rating (1,2,3,4 y 5 estrellas)?

```{r}
ggplot(data = df, aes(x = Rating)) +
  geom_bar(aes(y = ..count.., fill = ..count..), 
           stat="count", 
           show.legend = FALSE) +
  geom_label(aes(label = ..count.., y = ..count..), 
            stat = "count",
            vjust = -.5) +
  scale_fill_gradient(low = "lightcoral", high = "firebrick2")+
  labs(x = "Rating", y = "Number of ratings", title = "Total Ratings")+
  scale_y_continuous(limits=c(0,150000))+
  coord_flip() + 
  theme_classic()

# Image in the visualization 
image = image_read("imgs/icon-rating.png") 
grid.raster(image, x = 0.80, y = 0.25, height = 0.23)

```


```{r}
media = mean(df$Rating, na.rm = TRUE)
media

moda = names(which(table(df$Rating) == max(table(df$Rating))))
moda
```

Como se puede observar en el gráfico, las puntuaciones generalmente han sido positivas ya que la mayoria de los casos tienen una puntuación superior a 3.

La calificación de 4 que ha sido dada por un total de 2926 usuarios, es la que se ha dado más veces.

La calificación media de todas las películas es de 3.37.

### Analizar nº de votaciones/puntuación de cada película


```{r}
count_movies = table(df$Title, df$Rating)
d = as.data.frame(count_movies)
ggplot(d, aes(x=d$MovieID, y = Freq, fill=d$Rating)) + 
    geom_bar(stat="identity")
```




### Película con mejor y peor calificación (gráfico palabras)

### Película más votada y menos votada (gráfico palabras)

```{r}
#Más votada
df_more_voted = df[df$MovieID == which(count_mov == max(count_mov)),]

ggplot(data = df_more_voted, aes(x = Rating)) +
  geom_bar(aes(y = ..count.., fill = ..count..), 
           stat="count", 
           show.legend = FALSE) +
  geom_label(aes(label = ..count.., y = ..count..), 
            stat = "count",
            vjust = -.5) +
  scale_fill_gradient(low = "cadetblue1", high = "cadetblue4")+
  labs(x = "Rating", y = "Number of ratings", title = df_more_voted$Title[1])+
  scale_y_continuous(limits=c(0,60000))+
  coord_flip() + 
  theme_classic()

# Image in the visualization 
#image = image_read("imgs/mejor.jpg") 
#grid.raster(image, x = 0.80, y = 0.35, height = 0.4)
```

```{r}
#Menos votada
df_less_voted = df[df$MovieID == which(count_mov == min(count_mov)),]

ggplot(data = df_less_voted, aes(x = Rating)) +
  geom_bar(aes(y = ..count.., fill = ..count..), 
           stat="count", 
           show.legend = FALSE) +
  geom_label(aes(label = ..count.., y = ..count..), 
            stat = "count",
            vjust = -.5) +
  scale_fill_gradient(low = "cadetblue1", high = "cadetblue4")+
  labs(x = "Rating", y = "Number of ratings", title = df_less_voted$Title[1])+
  scale_y_continuous(limits=c(0,50))+
  coord_flip() + 
  theme_classic()

# Image in the visualization 
#image = image_read("imgs/mejor.jpg") 
#grid.raster(image, x = 0.80, y = 0.35, height = 0.4)
```


## Relación fecha puntuación / calificación

### ¿Cuántas puntuaciones hay por cada año?

### Media del rating por año



## Relación fecha release de la película / calificación

### Relación fecha película con la fecha puntuación y la puntuación 

### ¿Si las fechas de release y puntuación son cercanas, la puntuación es mejor o peor? Revisar la diferencia de las fechas


## Tiempos

### Tiempo medio que ha pasado desde el estreno de la película hasta que ha sido puntuada

### Cantidad de tiempo entre estreno y calificación (Nº de casos)
